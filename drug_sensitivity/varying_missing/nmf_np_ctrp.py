"""
Test the performance of Gibbs sampling for recovering the CTRP dataset, where we 
vary the fraction of entries that are missing.
We repeat this 10 times per fraction and average that.

GDSC has 0.7356934001670844 missing entries
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from HMF.code.models.nmf_np import nmf_np
from HMF.code.generate_mask.mask import try_generate_M_from_M
from HMF.drug_sensitivity.load_dataset import load_data_without_empty

import numpy, matplotlib.pyplot as plt, random

''' Settings '''
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]
repeats = 10
iterations = 1000

init_UV = 'random'
expo_prior = 1.
K = 2

metrics = ['MSE', 'R^2', 'Rp']

''' Load data '''
location = project_location+"DI_MMTF/data/datasets_drug_sensitivity/overlap/"
location_data = location+"data_row_01/"
R, M_original, _, _ = load_data_without_empty(location_data+"ctrp_ec50_row_01.txt")

''' Seed all of the methods the same '''
numpy.random.seed(0)
random.seed(0)

''' Generate matrices M - one list of (M_train,M_test)'s for each fraction '''
M_attempts = 1000
all_Ms_train_test = [ 
    [try_generate_M_from_M(M=M_original,fraction=fraction,attempts=M_attempts) for r in range(0,repeats)]
    for fraction in fractions_unknown
]

''' Make sure each M has no empty rows or columns '''
def check_empty_rows_columns(M,fraction):
    sums_columns = M.sum(axis=0)
    sums_rows = M.sum(axis=1)
    for i,c in enumerate(sums_rows):
        assert c != 0, "Fully unobserved row in M, row %s. Fraction %s." % (i,fraction)
    for j,c in enumerate(sums_columns):
        assert c != 0, "Fully unobserved column in M, column %s. Fraction %s." % (j,fraction)
        
for Ms_train_test,fraction in zip(all_Ms_train_test,fractions_unknown):
    for (M_train,M_test) in Ms_train_test:
        check_empty_rows_columns(M_train,fraction)

''' Run the method on each of the M's for each fraction '''
all_performances = {metric:[] for metric in metrics} 
average_performances = {metric:[] for metric in metrics} # averaged over repeats
for (fraction,Ms_train_test) in zip(fractions_unknown,all_Ms_train_test):
    print "Trying fraction %s." % fraction
    
    # Run the algorithm <repeats> times and store all the performances
    for metric in metrics:
        all_performances[metric].append([])
    for repeat,(M_train,M_test) in zip(range(0,repeats),Ms_train_test):
        print "Repeat %s of fraction %s." % (repeat+1, fraction)
    
        NMF = nmf_np(R,M_train,K)
        NMF.initialise(init_UV,expo_prior=expo_prior)
        NMF.run(iterations)
    
        # Measure the performances
        performances = NMF.predict(M_test)
        for metric in metrics:
            # Add this metric's performance to the list of <repeat> performances for this fraction
            all_performances[metric][-1].append(performances[metric])
            
    # Compute the average across attempts
    for metric in metrics:
        average_performances[metric].append(sum(all_performances[metric][-1])/repeats)
    
 
print "repeats=%s \nfractions_unknown = %s \nall_performances = %s \naverage_performances = %s" % \
    (repeats,fractions_unknown,all_performances,average_performances)

'''
1000 iterations
repeats=10 
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9] 
all_performances = {'R^2': [[0.40910052374279404, 0.35518063968665603, 0.4686793129653376, 0.4393414112764209, 0.38251912379572095, 0.4598033960502821, 0.44334112553808325, 0.31575325349258365, 0.32376810471832984, 0.43495486108472525], [0.3543986105405853, 0.3790020142559063, 0.39477881499777434, 0.42013413772960784, 0.41594077100518934, 0.41429581470583476, 0.4307775761629682, 0.3942632521993852, 0.45409466900520434, 0.44720119683374127], [0.4127250290274379, 0.40416075951674113, 0.36980350140923257, 0.40049902579448826, 0.4139963786758305, 0.430496597388229, 0.3783455276958, 0.3951636892354451, 0.3689790975945141, 0.4214692372214668], [0.3922440460418496, 0.2910067731504383, 0.42036534455078756, 0.342078473010053, 0.3553777520235559, 0.38739044522662214, 0.377930565920481, 0.41148792922342303, 0.38310793989083847, 0.34740889364530414], [0.38156797354241945, 0.3859727331384495, 0.3540849801708852, 0.3326402921775321, 0.35501629679290636, 0.3996594843554212, 0.3809525615952577, 0.40292705623126845, 0.3713826801813629, 0.3662942143617859], [0.35788577881575157, 0.3545117352972038, 0.37872829305603184, 0.3233766334681665, 0.3994647868841774, 0.3711742350027697, 0.3361289100149071, 0.39335924295796676, 0.3845512803236364, 0.3231809018230447], [0.3411178703759222, 0.3679640435865563, 0.3460910071553812, 0.3809415381774579, 0.3672832644471624, 0.35642220987503026, 0.37484305485535274, 0.33973651406297367, 0.36471836896248666, 0.3741289497832446], [0.3243558432441491, 0.35132027419486844, 0.37060655752463634, 0.33074616044773775, 0.3456986049306341, 0.3682473157854794, 0.36709578066616944, 0.2963518466226287, 0.2932360711246065, 0.3339675558181716], [0.3062507405122401, 0.32686849144449803, 0.3581712994191586, 0.3403530560198933, 0.3215314863610258, 0.29879521526713104, 0.33837997118664065, 0.3352161842397512, 0.269319898719509, 0.002574276080036464], [0.3140431109650058, 0.26661478686635653, 0.2893194871187945, 0.3093693406958036, 0.2868972418659754, 0.2864919540951312, 0.22983027464898498, 0.2558340991651171, -0.017238883421321516, 0.31517798565910593], [0.2743512861790267, 0.2748610069566235, 0.29816601649212615, 0.26251032993988554, 0.2656682955727244, 0.18300628875101188, 0.2514031239925377, 0.2987174684972195, -2697.349999039004, 0.2898668661945413], [0.0731089617928723, 0.022467711904366694, 0.24849441309296338, 0.24584119838315477, 0.20812196742214206, 0.05129985435007356, -0.03226266773959785, 0.09518929337875504, 0.18395438621287352, -0.969831389604261], [0.15380714667583661, -0.30559832735200887, 0.1727670112689873, 0.14192184345260528, -0.1259421105544436, 0.13733866379422255, -0.19509322639278093, -0.024060381991551028, -1466.130621886647, -0.04513455518465137], [-0.07965462377587462, -2498066.7334870696, 0.003999599219638217, -0.05145894423688824, 0.009417515796176668, -0.04748687554091546, -0.265332076734492, -13.894119744741673, -0.6529570288538076, -0.08694700631141772], [-698904.8520928668, -0.7110508601313961, -0.15558957578799726, -38953.14735768874, -478.2151869399507, -65.9903594485196, -0.14636794967929911, -6.730612076835128, -3.941768592681374, -0.8184798637957209], [-0.22998983119788075, -0.7571614793980153, -186643.10126030404, -0.28224478488368265, -0.3892265446608527, -0.2838681864105672, -0.4728708379566795, -1151948.0057564627, -0.33186243626972645, -8817631757.968481]], 'MSE': [[0.098017710744928974, 0.092345027554348161, 0.083232012431290664, 0.092116359850211355, 0.10638752970907939, 0.089106669395730739, 0.087789846479379499, 0.11633482618846425, 0.10849975293197209, 0.087555476530501108], [0.10018407959498569, 0.098884337728418759, 0.096302729127199199, 0.095131995012870244, 0.094547185846937457, 0.094034442318661121, 0.086428288041403914, 0.09830057939416896, 0.090169103905696907, 0.089021001753756657], [0.094983038022998068, 0.096426716221168329, 0.10005117714243565, 0.094073044056297919, 0.09225520105262934, 0.089689543514174908, 0.10080933101253246, 0.093800737753290384, 0.09975700374412369, 0.093334882152564455], [0.097724719305224389, 0.11307898504513893, 0.091542541367763464, 0.10377429018079039, 0.10195783937586965, 0.097377213438622462, 0.10057698034728417, 0.093549672648884433, 0.095760049004172759, 0.10440480889445553], [0.097849056749478622, 0.097695079755491854, 0.10320831824670154, 0.10496952878701674, 0.1022746443397613, 0.095500802688186753, 0.10021289404314414, 0.094323407722221878, 0.09818116265724508, 0.10000016207628146], [0.10152641155071428, 0.10147846509911268, 0.099499221052200368, 0.10658365456584874, 0.095547959553426251, 0.10153761638471381, 0.10550581712682987, 0.097005455626160725, 0.10048170786621879, 0.10829779753624837], [0.10596237890047705, 0.1009647477404471, 0.10418280220675828, 0.098866294380587139, 0.10180789571186298, 0.10153091109311914, 0.098031663691755436, 0.10648703901068381, 0.10107801330190748, 0.10019167991576432], [0.10793465490860323, 0.10373256933434381, 0.10103676028320273, 0.10564309439767618, 0.10418668645346743, 0.10020017134230867, 0.10063719146230431, 0.11154392313960693, 0.11169367202381499, 0.10611801502795919], [0.11046187013246961, 0.10704457289719461, 0.10302368697688294, 0.10568504680868146, 0.10667698858842097, 0.11172737045869383, 0.1049590935029989, 0.10741165619480954, 0.11478275199399068, 0.15863946081674832], [0.10956864982581006, 0.11611631561694859, 0.11123265359824214, 0.11014867495329451, 0.11283115061388455, 0.1147277143756915, 0.12163204132610868, 0.11754207192371509, 0.16228290186720717, 0.10908511278830418], [0.11529215782120664, 0.11391387088079276, 0.11325284316131055, 0.11705064200343415, 0.1159219011473079, 0.1288501046358978, 0.11965384290992349, 0.11089457879646569, 432.22400436019888, 0.1126776155631697], [0.14834739446144268, 0.15414415407294207, 0.12048642565789962, 0.1198210865178535, 0.12536642497358869, 0.15011463668056549, 0.16437710486262899, 0.14393751037094113, 0.12931219406247899, 0.3145067151190718], [0.1347707228155908, 0.20642966318965869, 0.13167350099144218, 0.13609389523697496, 0.18035236011964662, 0.13798168183268639, 0.18928240496585633, 0.16269362758217129, 233.99782853966042, 0.167305069542349], [0.17231207918330238, 399015.50408017577, 0.1577660253808737, 0.16665004896925661, 0.15730485226089055, 0.16649363680831666, 0.20144037378712829, 2.3617147136576895, 0.2628587728526367, 0.17311259263973325], [110903.82706433718, 0.27374709984512419, 0.18299922147479461, 6197.5497715480897, 76.572060431505051, 10.604222267279175, 0.18133554387585388, 1.2336250630001209, 0.78553557138902597, 0.28897029572583066], [0.19559742127090676, 0.28034672648162501, 29627.864493198209, 0.20404574083751892, 0.22050330101781138, 0.2039965612351731, 0.23480724713080361, 183385.74484788184, 0.21173187862633547, 1398963761.7755308]], 'Rp': [[0.6460887411923949, 0.60350183189859452, 0.68525578884937566, 0.66576644394297269, 0.63157466431652187, 0.68135467442537589, 0.67142202759439262, 0.57597492568757291, 0.58428759878490999, 0.67072331385434059], [0.60625945296754946, 0.62029920745417066, 0.63286730300959027, 0.65052685251951636, 0.64823603545801178, 0.64951147470308845, 0.66112207292451353, 0.63326734483477976, 0.67479464929232025, 0.6692521143981599], [0.64835655098554978, 0.64084219456878877, 0.61722642991190657, 0.63637881669478324, 0.647354295081632, 0.65857398055693828, 0.62611872636874955, 0.63429765611035915, 0.61888848481548686, 0.65382069642111584], [0.63392587184053117, 0.56565379323957432, 0.65300603090099441, 0.5973774697481764, 0.60782468917040833, 0.62867034716835146, 0.62315211819213268, 0.64542305220818708, 0.62537388666763949, 0.60346223995414805], [0.62774747400020314, 0.62663721055455956, 0.60592200073113189, 0.59386940910612229, 0.610048172052849, 0.63801691428894025, 0.62341278678844914, 0.64083516692140019, 0.61788961007185239, 0.61431087074889568], [0.61176142774660747, 0.60687399990872093, 0.62470812686998478, 0.59067833640275202, 0.63869361746544584, 0.61809176362458307, 0.59772015188830996, 0.63337977692969816, 0.62726593907220152, 0.58586215245484519], [0.60203296644595461, 0.61805855637360951, 0.60053887560031183, 0.62585750333300383, 0.61675411407144709, 0.61056944614062436, 0.62400651709737054, 0.59787973286131002, 0.6170938885910987, 0.62214449115125259], [0.59216736210849219, 0.60867910057355212, 0.61849907913216962, 0.59850305525716962, 0.6024479149588452, 0.61687589663418518, 0.61663832778536032, 0.57807025228348996, 0.56925804484656617, 0.59457482907833814], [0.58353622960904428, 0.58821622238450233, 0.60989193722292534, 0.59935893778640037, 0.58900791354284121, 0.57668789517605878, 0.59977724855112791, 0.59733044264939972, 0.56671302221766617, 0.13818216862378688], [0.58743819523414564, 0.55871727454596087, 0.57382910742330351, 0.58681029999712664, 0.57065927199320177, 0.57206236245769593, 0.54952792958711516, 0.55498024292985204, 0.4578659236961955, 0.58586427287141518], [0.56349614379922308, 0.57758519910653128, 0.57835426367067355, 0.55967679931389047, 0.5607016635401838, 0.53266066987121108, 0.55082283261538956, 0.57822440167241518, -0.0071375911594636727, 0.58077865403558271], [0.49231915464041975, 0.47713065075967731, 0.55041365696450462, 0.55456824572011398, 0.53105327984738304, 0.48029728198511129, 0.47446658018923155, 0.48716878825832072, 0.52035919815600895, 0.33124092879600292], [0.51128731965464247, 0.39726578069516194, 0.51432628172778183, 0.51031800344010692, 0.4276479500132781, 0.51866739202007794, 0.42816715673001621, 0.11994638897281641, -0.0039379711931879771, 0.10580092118146546], [0.45158500896285225, 0.016471274210462464, 0.46720376037304934, 0.10678946444282525, 0.47581122848108459, 0.11420532880436292, 0.42217449787587674, 0.12365207726699656, 0.35771941800121937, 0.086475302964942574], [0.0070173182614290831, 0.34722420734205772, 0.072291531393121805, 0.0051712913090783174, 0.030187609652587537, 0.045751631535116251, 0.084528063748147045, 0.16251656914508655, 0.21123847214064501, 0.34444858544873325], [0.080301299221851377, 0.053994446978643529, -0.0090309934356583455, 0.066760539111871187, 0.050090809159141922, 0.061909028370914998, 0.055096358615357839, 0.015556015643312941, 0.061288584098040506, 0.0037076502877853067]]} 
average_performances = {'R^2': [0.40324417523509337, 0.41048868574361974, 0.3995638843559185, 0.37083981626833534, 0.37304982725472885, 0.36223617976436556, 0.36132468212815677, 0.3381626010359081, 0.2897460619249884, 0.2536339397658954, -269.49514483564286, 0.012638372919334251, -146.62206158229307, -249808.17980262544, -73841.47088658628, -881897035.1822722], 'MSE': [0.096138521181590636, 0.094300374272409893, 0.09551806746722151, 0.099974709960820626, 0.099421505706552935, 0.10174641063614738, 0.10191034259533627, 0.10527267383732875, 0.1130412498370891, 0.11851672868892067, 43.327151191711835, 0.1570413646779413, 23.54444114659368, 39901.93237332713, 11719.149933137936, 139917677.69359007], 'Rp': [0.64159500105464518, 0.64461365075616994, 0.63818578315153096, 0.61838694990901433, 0.61986896152644033, 0.61350352923631479, 0.61349360916659834, 0.59957138626581685, 0.54487020177637535, 0.55977548807360122, 0.50751630364656364, 0.48990177653167744, 0.35294892232421593, 0.2622087361383672, 0.13103752799760024, 0.043967373805126123]}
'''