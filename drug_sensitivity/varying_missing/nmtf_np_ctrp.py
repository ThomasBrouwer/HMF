"""
Test the performance of Gibbs sampling for recovering the CTRP dataset, where we 
vary the fraction of entries that are missing.
We repeat this 10 times per fraction and average that.

GDSC has 0.7356934001670844 missing entries
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from HMF.code.models.nmtf_np import nmtf_np
from HMF.code.generate_mask.mask import try_generate_M_from_M
from HMF.drug_sensitivity.load_dataset import load_data_without_empty

import numpy, matplotlib.pyplot as plt, random

''' Settings '''
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]
repeats = 10
iterations = 1000

init_FG = 'kmeans'
init_S = 'random'
expo_prior = 1.
K, L = 2, 4

metrics = ['MSE', 'R^2', 'Rp']

''' Load data '''
location = project_location+"DI_MMTF/data/datasets_drug_sensitivity/overlap/"
location_data = location+"data_row_01/"
R, M_original, _, _ = load_data_without_empty(location_data+"ctrp_ec50_row_01.txt")

''' Seed all of the methods the same '''
numpy.random.seed(0)
random.seed(0)

''' Generate matrices M - one list of (M_train,M_test)'s for each fraction '''
M_attempts = 1000
all_Ms_train_test = [ 
    [try_generate_M_from_M(M=M_original,fraction=fraction,attempts=M_attempts) for r in range(0,repeats)]
    for fraction in fractions_unknown
]

''' Make sure each M has no empty rows or columns '''
def check_empty_rows_columns(M,fraction):
    sums_columns = M.sum(axis=0)
    sums_rows = M.sum(axis=1)
    for i,c in enumerate(sums_rows):
        assert c != 0, "Fully unobserved row in M, row %s. Fraction %s." % (i,fraction)
    for j,c in enumerate(sums_columns):
        assert c != 0, "Fully unobserved column in M, column %s. Fraction %s." % (j,fraction)
        
for Ms_train_test,fraction in zip(all_Ms_train_test,fractions_unknown):
    for (M_train,M_test) in Ms_train_test:
        check_empty_rows_columns(M_train,fraction)

''' Run the method on each of the M's for each fraction '''
all_performances = {metric:[] for metric in metrics} 
average_performances = {metric:[] for metric in metrics} # averaged over repeats
for (fraction,Ms_train_test) in zip(fractions_unknown,all_Ms_train_test):
    print "Trying fraction %s." % fraction
    
    # Run the algorithm <repeats> times and store all the performances
    for metric in metrics:
        all_performances[metric].append([])
    for repeat,(M_train,M_test) in zip(range(0,repeats),Ms_train_test):
        print "Repeat %s of fraction %s." % (repeat+1, fraction)
    
        NMTF = nmtf_np(R,M_train,K,L)
        NMTF.initialise(init_S,init_FG,expo_prior=expo_prior)
        NMTF.run(iterations)
    
        # Measure the performances
        performances = NMTF.predict(M_test)
        for metric in metrics:
            # Add this metric's performance to the list of <repeat> performances for this fraction
            all_performances[metric][-1].append(performances[metric])
            
    # Compute the average across attempts
    for metric in metrics:
        average_performances[metric].append(sum(all_performances[metric][-1])/repeats)
    
 
print "repeats=%s \nfractions_unknown = %s \nall_performances = %s \naverage_performances = %s" % \
    (repeats,fractions_unknown,all_performances,average_performances)

'''
1000 iterations
repeats=10 
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9] 
all_performances = {'R^2': [[0.409102042727287, 0.35524471904624544, 0.4686013687222099, 0.4393369917901906, 0.3820908666623054, 0.4590424858299418, 0.443256434097969, 0.31587870796576134, 0.3243142425805057, 0.4350164087809526], [0.3545312839337411, 0.37903462135464483, 0.3948336713190106, 0.4202634407007363, 0.4159716904530002, 0.41432095931532475, 0.4311983669550433, 0.4093199214934139, 0.4540337906837829, 0.4469645348407638], [0.41184787143095736, 0.40433642620123733, 0.3636821241434829, 0.4002559217833104, 0.41923909835671425, 0.43021287288464993, 0.3783231970687043, 0.3953699094340759, 0.3682666529319244, 0.4278018282863837], [0.39692124574654397, 0.3321584347986458, 0.4203296589692439, 0.3734796445050286, 0.38135912119881876, 0.3873928924890828, 0.37508958395697645, 0.4114564246180116, 0.3833925504133927, 0.35565290848581177], [0.4034402568548797, 0.38653545136872447, 0.3786309095218259, 0.33869984741578973, 0.35529679334046504, 0.3993183686632421, 0.38130013161978393, 0.4029355360092136, 0.3719764196033494, 0.36607134529602225], [0.372765483990646, 0.35724870121630126, 0.37606528681183027, 0.36746287162235336, 0.39946701486226843, 0.37114102882879907, 0.3883444134268046, 0.38907902609238365, 0.38456088492684526, 0.3875107821647187], [0.36671312432723024, 0.38834088563608915, 0.3472759753633603, 0.38394129408682653, 0.3806223061393148, 0.3580029936817106, 0.34145742075694796, 0.3888884265598259, 0.3644398598616203, 0.37398403004338454], [0.3420583357827879, 0.35547879089180356, 0.34723873743330835, 0.31910423335058247, 0.3834798701199733, 0.35033565080395934, 0.3645101178041742, 0.3470611963761455, 0.31621997027788673, 0.33554220984545224], [0.3063086773187026, 0.3206233188116362, 0.3582104801997782, 0.35643657252671535, 0.3595556486472795, 0.34569322212894926, 0.37032209267487814, 0.33308845309969703, 0.31715821628782115, -0.009222925028883111], [0.2746228273836754, 0.2766541850819967, 0.26333176589625007, 0.2905281739347392, 0.30211411650915254, 0.3112180881636605, 0.32623038477734, 0.3052215242427334, -0.004398284459765867, 0.30128360562063283], [0.25596332855473225, 0.2902557003912557, 0.2982998490683465, 0.2983108095900525, 0.29222066064633145, 0.1971836204965436, 0.28265975606568006, 0.29814733984556463, 0.11688029036943204, 0.25966160083395196], [0.24554518739460773, -9.028210141113982, 0.20148863418923635, 0.18057329326410965, 0.18493469575039578, 0.19730349418453996, 0.13573893716203078, 0.28773764716303085, 0.11009253259800467, 0.25202497507958543], [0.12888309181847435, 0.17106642364257085, 0.14354407406915182, 0.21948972549172985, -2.866085001683973, -0.02711949273391312, 0.1165881558040609, -0.04548225265333716, -0.2978239275967818, -0.05692985164069331], [-0.029325053052584815, -0.03014305933929351, -0.09202319692929417, -0.07735421568907008, -0.031192135514548358, -0.05831166817793898, -23.280991294906233, -0.20375738479214722, -0.8924120726325806, -0.09055079384910258], [-112198.06659312532, -1.6426854499663617, -0.13769121968524334, -231.09764170933107, -41389.41294991291, -451.0318363592854, -0.3411953930905989, -1.483810411252437, -277075.13510746026, -8.663594340910661], [-0.2317213795239481, -0.3822814408184816, -112517.5427750996, -0.21150733824361811, -0.37397816175571763, -0.2484553000552978, -0.3605895972093711, -5232334.253380354, -0.32064953424051956, -1990273830.8017478]], 'MSE': [[0.098017458777566263, 0.092335850704844014, 0.08324422248892864, 0.092117085973010743, 0.10646131534400373, 0.089232183282615535, 0.087803203040941413, 0.11631349656664845, 0.10841212644832598, 0.087545939526284269], [0.10016349140853337, 0.098879145551571124, 0.096294000395330842, 0.09511078174544943, 0.094542180623779698, 0.094030405367261274, 0.086364396974819624, 0.095857142834106387, 0.090179159392203792, 0.0890591130658131], [0.095124905286982961, 0.096398287476660516, 0.10102301846897548, 0.094111191674630154, 0.091429833869522886, 0.089734226515352941, 0.10081295221318154, 0.093768756196583342, 0.099869632889374699, 0.092313239607705252], [0.096972644355898252, 0.1065156104515934, 0.091548177243386125, 0.098821367759107479, 0.097848449305247359, 0.097376824434570672, 0.10103631393845025, 0.093554680609926402, 0.095715868961424158, 0.10308588991813954], [0.094388397858087267, 0.097605548222686203, 0.099286217025424534, 0.1040164166189264, 0.10223016618551112, 0.095555066596025251, 0.10015662856835246, 0.094322068117805261, 0.098088428930495589, 0.1000353313033948], [0.099173741228986326, 0.10104818136556337, 0.099925712463274877, 0.099639063806858857, 0.095547605071697503, 0.10154297824477412, 0.097207460055301537, 0.09768988769308809, 0.10048013976329981, 0.098004375888515544], [0.10184611306884822, 0.09770964382364998, 0.10399400940870218, 0.09838722048192429, 0.099661564361382321, 0.10128152644592311, 0.10326690786442244, 0.09855983762065991, 0.10112232616289181, 0.10021487918689934], [0.10510666860238768, 0.1030675668617331, 0.10478800501753427, 0.10748079652295417, 0.098170644213973673, 0.10304108036417667, 0.10104833400259813, 0.10350536042297573, 0.1080614038944273, 0.10586712761070122], [0.11045264517416686, 0.10803770994197288, 0.10301739784011731, 0.10310823324138789, 0.10069837197651819, 0.10425481593466718, 0.09989181021355388, 0.10775544182898464, 0.10726781661853632, 0.16051579263593438], [0.1158652951643141, 0.11452678543426262, 0.1153001398176626, 0.11315365239723854, 0.11042345066439951, 0.11075190378278965, 0.10640768000285683, 0.10974125726116808, 0.16023440598766928, 0.11129834481338612], [0.11821366415347426, 0.11149548056254217, 0.11323124700022301, 0.11136857037964942, 0.11173033401118579, 0.12661416248148763, 0.11465786140927965, 0.11098473386784552, 0.1414588683313438, 0.11747031867229739], [0.12074925862417867, 1.5813185793372866, 0.12802270800103563, 0.13019088037206802, 0.12903732533297249, 0.12701220178763503, 0.13762459478060074, 0.11330687076099967, 0.14101648875764278, 0.11942299697340379], [0.1387403059613555, 0.13106364751639865, 0.13632501574336003, 0.12379138510845432, 0.61926590003239568, 0.16428657353985615, 0.13991738447839955, 0.16609694432877189, 0.20699450775141942, 0.16919325980843589], [0.16427951693167864, 0.16454439829106829, 0.1729759940540847, 0.1707542969565238, 0.16375367939206509, 0.16821419210682889, 3.8655243570453224, 0.1908761025196809, 0.30093771735170122, 0.17368654978791884], [17803.980093974977, 0.42279717955060941, 0.18016483693108748, 36.926406658175715, 6613.6242925097949, 71.554266973651224, 0.2121538691987257, 0.39635810781959019, 44043.575903622899, 1.5356187165243818], [0.19587277833386305, 0.2205364057619365, 17861.18133818459, 0.19278917354648037, 0.21808301990621867, 0.19836973200429694, 0.21690720568461544, 832967.16516099439, 0.20994931554260854, 315767435.38522333]], 'Rp': [[0.64608224534363212, 0.60355688562079934, 0.68519884734141923, 0.66576346839022094, 0.6312749415851151, 0.68083770124973175, 0.6713498960498645, 0.57605995479855399, 0.58464051564635611, 0.6707184320407753], [0.60635065040574099, 0.62031574478691953, 0.63290503465039105, 0.65061230827285821, 0.64825810383137694, 0.64950007002063914, 0.66142715886619818, 0.64272121887865985, 0.67474982143399143, 0.6690822949797689], [0.64777485238255372, 0.64094315193799234, 0.61361754438092031, 0.63621693868791174, 0.65080847618686266, 0.65838610364805372, 0.62610118994766317, 0.63443556031417303, 0.61846975605895604, 0.65777001953308611], [0.63672056645388919, 0.58943115845919725, 0.65297570102199354, 0.61886099072949108, 0.62461921237197615, 0.62867149300430381, 0.62141790740317315, 0.64540157321232294, 0.62556038259837166, 0.60830564734227965], [0.64179776348192397, 0.62698838417287606, 0.62203320814699792, 0.59886558877184171, 0.61020625063837175, 0.63778891117066538, 0.62364165816137307, 0.6408420531249408, 0.61826609052739212, 0.61416322981108418], [0.62181586076263984, 0.60770343383644898, 0.62326995427478393, 0.61909785357370384, 0.63869515516917652, 0.61806571665247012, 0.6319263767917821, 0.6304438631352578, 0.62727206574651939, 0.62958094532219477], [0.61967194796830505, 0.63102476473946156, 0.60360882067116306, 0.62773406983859281, 0.62665628197613155, 0.6116175214329157, 0.60396287393701187, 0.63049717797594051, 0.61692076045651367, 0.62204997703142917], [0.60241528438517122, 0.6131825874947473, 0.60354694503052098, 0.58969720478345666, 0.62817515156940107, 0.60382473028791073, 0.61510615660233137, 0.60684989558403624, 0.5838566745308158, 0.59730361427919343], [0.58356795038601161, 0.58473304376596746, 0.60992031117255807, 0.61043442282943572, 0.6123095030587935, 0.60354399816711635, 0.61974577458779012, 0.59609824713979243, 0.59064302829742998, 0.13347131640168688], [0.56526589815907335, 0.56915854137453525, 0.56190659288384615, 0.57537328013518974, 0.57646319839515558, 0.58733336366667999, 0.5972760197820518, 0.58485588074776684, 0.46243963112666608, 0.57940382029425908], [0.55830037054055071, 0.5840098178566977, 0.57847363672295926, 0.58062234992696982, 0.57621060605514918, 0.5399144751235484, 0.57163565291063956, 0.57998553017398724, 0.49703368770337769, 0.56887584946674818], [0.55582759288270067, 0.12834294639791219, 0.53144529688278042, 0.52839106048478923, 0.52298499218409034, 0.53455454508848554, 0.51709809990783118, 0.57483700253629011, 0.49642513296395013, 0.55367812072330913], [0.50080079089924545, 0.52687198517931699, 0.50936739824174748, 0.53993797785231401, 0.2372911739525172, 0.46354905689743781, 0.50376095818990485, 0.11522559283118851, 0.40644107347621744, 0.1068094927286298], [0.45133520878339428, 0.46958503658157136, 0.46584399004528187, 0.098923311569375214, 0.46009888940171001, 0.11708356172645859, 0.10398919443245709, 0.41927167679254351, 0.35566018169566543, 0.09001691289146195], [0.0059640943244579575, 0.29295700254299367, 0.082217252062042251, 0.035421659682794399, 0.027849054708801935, 0.039703968141947182, 0.059980216616062135, 0.30584099438789447, -0.014305471611951471, 0.17160769417376182], [0.082571247249587157, 0.065148389668763587, 0.017580194658985734, 0.076373247153259605, 0.061428444393879393, 0.077598777556341286, 0.054988874641809224, 0.034903108311462427, 0.054196944729325625, 0.024764304190341771]]} 
average_performances = {'R^2': [0.40318842682033684, 0.41204722810494615, 0.39993359025214403, 0.3817232465181557, 0.37842050596932963, 0.3793645493942951, 0.36936663164563105, 0.34610291126860737, 0.3058173756666574, 0.2646806387150415, 0.25895829558618905, -0.7232770744328442, -0.25138690554827103, -2.47860608748828, -43135.7013105382, -199561868.4727086], 'MSE': [0.096148288215316902, 0.094047981735886868, 0.095458604419896967, 0.098247582697774366, 0.0985684269426709, 0.099025914558136002, 0.10060440284253036, 0.10401369875134621, 0.11050000354058395, 0.11677029153257475, 0.11772252408693287, 0.27277019047278245, 0.19956749242688471, 0.55355468044368727, 6857.2408056449522, 31661826.518423013], 'Rp': [0.64154828880664683, 0.64559224061265452, 0.6384523593078173, 0.62519646325969991, 0.62345931380074671, 0.6247871225264976, 0.61937441960274653, 0.60439582445475837, 0.55444675958065825, 0.56594762265652232, 0.56350619764806287, 0.4943584790052139, 0.39100555002485199, 0.30318079639199197, 0.10072364650288043, 0.05495535325537558]}
'''