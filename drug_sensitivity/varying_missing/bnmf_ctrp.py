"""
Test the performance of Gibbs sampling for recovering the CTRP dataset, where we 
vary the fraction of entries that are missing.
We repeat this 10 times per fraction and average that.

GDSC has 0.7356934001670844 missing entries
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from HMF.code.models.bnmf_gibbs import bnmf_gibbs
from HMF.code.generate_mask.mask import try_generate_M_from_M
from HMF.drug_sensitivity.load_dataset import load_data_without_empty

import numpy, matplotlib.pyplot as plt, random

''' Settings '''
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]
repeats = 10
iterations, burn_in, thinning = 200, 180, 2

init_UV = 'random'
K = 3

alpha, beta = 1., 1.
lambdaU = 1.
lambdaV = 1.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

metrics = ['MSE', 'R^2', 'Rp']

''' Load data '''
location = project_location+"DI_MMTF/data/datasets_drug_sensitivity/overlap/"
location_data = location+"data_row_01/"
R, M_original, _, _ = load_data_without_empty(location_data+"ctrp_ec50_row_01.txt")

''' Seed all of the methods the same '''
numpy.random.seed(0)
random.seed(0)

''' Generate matrices M - one list of (M_train,M_test)'s for each fraction '''
M_attempts = 1000
all_Ms_train_test = [ 
    [try_generate_M_from_M(M=M_original,fraction=fraction,attempts=M_attempts) for r in range(0,repeats)]
    for fraction in fractions_unknown
]

''' Make sure each M has no empty rows or columns '''
def check_empty_rows_columns(M,fraction):
    sums_columns = M.sum(axis=0)
    sums_rows = M.sum(axis=1)
    for i,c in enumerate(sums_rows):
        assert c != 0, "Fully unobserved row in M, row %s. Fraction %s." % (i,fraction)
    for j,c in enumerate(sums_columns):
        assert c != 0, "Fully unobserved column in M, column %s. Fraction %s." % (j,fraction)
        
for Ms_train_test,fraction in zip(all_Ms_train_test,fractions_unknown):
    for (M_train,M_test) in Ms_train_test:
        check_empty_rows_columns(M_train,fraction)

''' Run the method on each of the M's for each fraction '''
all_performances = {metric:[] for metric in metrics} 
average_performances = {metric:[] for metric in metrics} # averaged over repeats
for (fraction,Ms_train_test) in zip(fractions_unknown,all_Ms_train_test):
    print "Trying fraction %s." % fraction
    
    # Run the algorithm <repeats> times and store all the performances
    for metric in metrics:
        all_performances[metric].append([])
    for repeat,(M_train,M_test) in zip(range(0,repeats),Ms_train_test):
        print "Repeat %s of fraction %s." % (repeat+1, fraction)
    
        BNMF = bnmf_gibbs(R,M_train,K,priors)
        BNMF.initialise(init_UV)
        BNMF.run(iterations)
    
        # Measure the performances
        performances = BNMF.predict(M_test,burn_in,thinning)
        for metric in metrics:
            # Add this metric's performance to the list of <repeat> performances for this fraction
            all_performances[metric][-1].append(performances[metric])
            
    # Compute the average across attempts
    for metric in metrics:
        average_performances[metric].append(sum(all_performances[metric][-1])/repeats)
    
 
print "repeats=%s \nfractions_unknown = %s \nall_performances = %s \naverage_performances = %s" % \
    (repeats,fractions_unknown,all_performances,average_performances)

'''
200 iterations
repeats=10 
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9] 
all_performances = {'R^2': [[0.40782149920348054, 0.3653120142973486, 0.49934841033677646, 0.45435635423440257, 0.4327143347966125, 0.4294260743940749, 0.4491906480122979, 0.3382706775616051, 0.36107141122674447, 0.48157576924943146], [0.38606824760635006, 0.37979288555123036, 0.3944617668173269, 0.422362269764444, 0.4310007472222208, 0.4527801029904158, 0.4475401170771387, 0.4225353893646312, 0.4508746341867641, 0.4637126138280966], [0.42880241254517937, 0.4089208005163698, 0.36535622978169613, 0.4108171428708386, 0.4496412492163069, 0.4324078110644658, 0.3947735047164893, 0.40377987913150515, 0.3853355878043945, 0.4490511759995456], [0.3934087422386793, 0.35573178512470505, 0.44537304274757195, 0.3901054313613992, 0.38444212896291297, 0.40362699750528874, 0.4001597233970928, 0.42769366022269395, 0.41003465146923, 0.3702533305490556], [0.409486584423831, 0.39507337404827214, 0.3927325129140281, 0.37480540755503533, 0.4045812085450067, 0.4265735873001443, 0.4125524077825258, 0.40014689386353297, 0.40012632565239403, 0.3929501509337592], [0.40724033514998337, 0.38567820847495626, 0.40322680534465205, 0.38234413368367504, 0.4084864764660041, 0.39985078590518297, 0.4031811018726136, 0.4047056073811316, 0.41705452414652133, 0.39167783935658607], [0.3926242280031701, 0.41331214983484776, 0.3854637701969227, 0.4020156985736574, 0.4105722299893425, 0.3812537704341662, 0.3887629342306661, 0.3961923554284813, 0.3983225835479377, 0.393620546755613], [0.37121248604994095, 0.3786820926735275, 0.39299005531740816, 0.3793111719157092, 0.39884462692333045, 0.38964987531995876, 0.38315397233753334, 0.3826683958790609, 0.3583518221298553, 0.37797033142638403], [0.36366858569785876, 0.35643553871537625, 0.3955036817084451, 0.3616728333701622, 0.38005122228606725, 0.37605383704388673, 0.3937782493391865, 0.36456938743497624, 0.3579222018488092, 0.37844534849949785], [0.3629894976399378, 0.3431107092410439, 0.34566006396184124, 0.3626405152461266, 0.352678527165486, 0.3654892267916292, 0.34880061199998513, 0.3451325417079405, 0.3357788683343115, 0.33872641033989326], [0.33306418054018494, 0.3463778818635176, 0.33100311092699897, 0.34682399424163424, 0.340737342526633, 0.32049414308167234, 0.33318143473763984, 0.347915402066153, 0.3043032349048279, 0.3388472572855752], [0.3475982934830978, 0.32894970562084347, 0.30295887281899847, 0.3130982441717667, 0.3264327153732155, 0.3269143895719716, 0.3354838072506465, 0.3476816779897943, 0.29401067636856304, 0.3120994337872328], [0.27806604901656373, 0.296385361355452, 0.28341069427180243, 0.3048494197466115, 0.28805162042460153, 0.3077771513238543, 0.28466332417876405, 0.27746783673034714, 0.31100145295781034, 0.29248807529722454], [0.23145412333267057, 0.2536783712489342, 0.2860408706558111, 0.2491683135199364, 0.26273879293376023, 0.28365156099189814, 0.25316814886238737, 0.24393780832803424, 0.24402210275663472, 0.267684994423803], [0.21438355049235558, 0.2604381101939731, 0.22530599455393263, 0.1778543728212385, 0.1881804300696942, 0.22741791872227235, 0.18845396782090706, 0.18996485943048513, 0.1623666495010334, 0.20764109190660263], [0.16993940191500223, -0.03375256413449934, 0.13512571282579822, 0.0714635269107794, 0.10763664486276525, 0.12947784398485074, 0.05337446786201494, 0.13462174147976413, 0.08820476691064993, 0.19282574399745844]], 'MSE': [[0.098229873832505532, 0.090894106373673303, 0.0784276621472417, 0.089649400605376253, 0.097739254584451568, 0.094117478308922975, 0.086867326955217816, 0.11250644026094248, 0.10251452867983481, 0.08033142388493425], [0.095269602190905772, 0.098758403689884283, 0.096353177799186424, 0.094766450738896058, 0.092109285203379965, 0.087855813792976897, 0.083883135823629495, 0.09371250136498209, 0.090700968384094291, 0.086362054460830923], [0.092382759098379466, 0.095656382393708342, 0.10075723432047802, 0.092453936291564245, 0.086643589488223177, 0.089388551665147142, 0.098145321587479128, 0.092464500238298525, 0.097171234478972995, 0.088885063454890959], [0.0975374408291029, 0.1027558417711094, 0.087593039340633089, 0.096198974116494029, 0.097360819827064085, 0.094796335937728834, 0.096982941784739943, 0.090973615325171148, 0.091580220170240742, 0.10075004093023922], [0.093431740660352661, 0.096247118260140735, 0.097032975149927925, 0.098337344912943048, 0.094415168672435698, 0.091219368455659866, 0.095097434643288098, 0.09476260764123122, 0.093691810483226584, 0.095793796854591315], [0.093722829519699985, 0.096578723254716475, 0.0955756834720876, 0.097294924698601862, 0.094112566569898262, 0.096907162629723695, 0.094849537016407914, 0.095191104648596411, 0.095175040801848187, 0.097337605229557506], [0.097679051826792707, 0.093720602749318302, 0.097909811883676465, 0.095500660480001456, 0.094842443019131639, 0.097613481054174708, 0.09584886952438873, 0.097381862804645405, 0.095731333840514701, 0.097071395243344544], [0.10044927148472738, 0.099357048380720112, 0.097443529168665957, 0.097977007499515809, 0.09572406055762149, 0.096805583260446915, 0.098083801454144137, 0.097860825287757719, 0.10140308270647741, 0.099107114516948314], [0.10131954317292358, 0.10234268046352413, 0.097031247462115028, 0.10226930799904062, 0.097475811118901842, 0.099417268125795308, 0.096170736435050364, 0.10266894721923639, 0.10086419013858465, 0.098857581489540339], [0.1017503895421806, 0.10400477517844485, 0.10241446912023983, 0.10165245601069002, 0.10242286369514425, 0.10202543779955488, 0.10284318931993203, 0.10343725477975781, 0.105965014201667, 0.10533409061247227], [0.10596376495851838, 0.10267910881159258, 0.10795401980237575, 0.10366880231559517, 0.10407147090202708, 0.10716655411065791, 0.10658260328690934, 0.10311485539583831, 0.11143730121628503, 0.10490584233536092], [0.10441582593266355, 0.10581592160908174, 0.11175431748451042, 0.10913525710752882, 0.10663602092601954, 0.10650362216936375, 0.10581729952286766, 0.10377095955254062, 0.1118724577169057, 0.1098314041241832], [0.1149803617661618, 0.11124932517744159, 0.11406196796261943, 0.11025306904861364, 0.11403922931397675, 0.11072024310657644, 0.11329714148611843, 0.11478949948100162, 0.10989080417906369, 0.11325846148444084], [0.1226593533153733, 0.11920969832405295, 0.11309081204462373, 0.1190023994806419, 0.11707734298214946, 0.11386057392922518, 0.11889533982063216, 0.11988645405797572, 0.12021814173288027, 0.11663213432500576], [0.12466324411820391, 0.11832080928022928, 0.12268058041381057, 0.13080220694126657, 0.12971771108742275, 0.12229568817110167, 0.12837251875949271, 0.12926268209883834, 0.13314884747399477, 0.12591186328278559], [0.13199923151063192, 0.16493028713922098, 0.13729005101699673, 0.14775955011065534, 0.14163929293701077, 0.1383191266718794, 0.15091244224335029, 0.13776481052621106, 0.14495199531661551, 0.1280624508317843]], 'Rp': [[0.64047248427964398, 0.60862708702244239, 0.70806365491494649, 0.67429787709274003, 0.66287655182560656, 0.65930531986848695, 0.6722514776352827, 0.59297498378995783, 0.60639697628695455, 0.69575851922926635], [0.62397566743231758, 0.61907457587281811, 0.62962658784136361, 0.65044075081856689, 0.65694018896134831, 0.67339133933446327, 0.67324923061697184, 0.65052998405280094, 0.67166241983865871, 0.68112894903287113], [0.65582189477365027, 0.64128780591663692, 0.6103582922556483, 0.64150597453986424, 0.67061024992566032, 0.65847277428854922, 0.63293784562650957, 0.63716621525424977, 0.62531493941214378, 0.67039181914750445], [0.63009234035330131, 0.60135702562663695, 0.66751825663989328, 0.62697249691830281, 0.62330557569417033, 0.63698628108195088, 0.63467370863236106, 0.6542668053043329, 0.6421340171677582, 0.61410170567640299], [0.64166926230280408, 0.62974652802416931, 0.62852654407216568, 0.6171799692853166, 0.63831810725294702, 0.65363071828112462, 0.64299305753137503, 0.63493362458572666, 0.63399882542908892, 0.62917490615996485], [0.63987770741336314, 0.62304507815578825, 0.636917795639666, 0.62382144869327483, 0.64229386979127379, 0.63415949277150707, 0.63693802352841278, 0.63759882276808477, 0.64640359987929186, 0.62812908444049131], [0.62878993404804739, 0.64429943878640306, 0.62432001589029484, 0.63536954599153128, 0.64198765189243112, 0.6212413877158538, 0.62754881764092296, 0.63099093366842818, 0.6335269502116222, 0.62994402337793398], [0.61384688589290937, 0.6205372619368138, 0.6285251060293281, 0.62107434315703902, 0.63346355311329705, 0.62612759194678524, 0.62257717661882817, 0.62358362267019429, 0.60380319350837675, 0.61844392271297655], [0.60960970697617045, 0.60122327780333329, 0.63100575640279322, 0.60771074613117915, 0.62022762659243003, 0.61689382889900535, 0.62970342916815092, 0.60931334941078874, 0.60722481954621266, 0.61879712735566161], [0.60878725417285695, 0.59847273881832264, 0.59836813494209573, 0.60781149312794791, 0.60073252168561031, 0.61095123350844993, 0.60053367273829672, 0.59601211170979751, 0.5893017714937695, 0.59156326878106702], [0.58860285407538859, 0.60238255183975642, 0.58624133224481667, 0.59596187395706057, 0.59242933354329086, 0.58025617789045991, 0.58812429494414464, 0.5997970979589079, 0.56878555133841724, 0.59400492389503334], [0.59665952714312032, 0.58756696831218647, 0.56880916324306141, 0.57457378833949602, 0.58440505734705162, 0.58627160768197084, 0.59104309726545845, 0.596595126473492, 0.56295489782000085, 0.57087978118017912], [0.55100017482390262, 0.56777606401232161, 0.55634068802470638, 0.56786331213053498, 0.55647651946798593, 0.57223228813962501, 0.56212556531780145, 0.55998943505895526, 0.5695432272718185, 0.56359900139496255], [0.53504724979487328, 0.54131421363272281, 0.56440931697537411, 0.54056044083128674, 0.5467651754210503, 0.55908868216546526, 0.54664955515360891, 0.5426831853360693, 0.54852048462625436, 0.54349650719693876], [0.53105809586595232, 0.53823971923504277, 0.52775992376692149, 0.51144194783768715, 0.5079256199353327, 0.54176400202222186, 0.51178883300621592, 0.51592645755208644, 0.50984750976651516, 0.5288570761476038], [0.50281960343983867, 0.43675375804309235, 0.50184768932772394, 0.47091016432299254, 0.50337051654263398, 0.49266395193050039, 0.4645180421671562, 0.48817343214388609, 0.48750907000076238, 0.51209914082676022]]} 
average_performances = {'R^2': [0.4219087193312774, 0.42511287744086185, 0.41288857936467915, 0.398082949357863, 0.400902845301853, 0.4003445817781307, 0.3962140266994805, 0.38128348299727083, 0.3728100885944266, 0.3501006972428195, 0.33427479821748374, 0.323522781643613, 0.29241609853030315, 0.257554508705387, 0.20420069455124948, 0.10489172866145839], 'MSE': [0.093127749563310075, 0.091977139344876613, 0.093394857301714207, 0.095652927003252328, 0.095002936573379729, 0.095674517784113788, 0.096329951242598869, 0.098421132431702529, 0.099841731362471223, 0.10318499402600836, 0.10575443231351604, 0.1075553086145665, 0.11265401030060143, 0.11805322500125606, 0.12651761516271462, 0.14236292383043564], 'Rp': [0.65210249319453273, 0.65300196938021804, 0.64438678111404157, 0.6331408213095111, 0.6350171542924683, 0.63491849230811537, 0.63180186992234699, 0.62119826575865489, 0.61517096682857253, 0.60025342009782146, 0.58965859916872765, 0.58197590148060174, 0.56269462756426136, 0.5468534811133644, 0.52246091851355803, 0.4860665368745346]}
'''