"""
Test the performance of Gibbs sampling for recovering the CTRP dataset, where we 
vary the fraction of entries that are missing.
We repeat this 10 times per fraction and average that.

GDSC has 0.7356934001670844 observed entries
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from HMF.code.models.bnmtf_gibbs import bnmtf_gibbs
from HMF.code.generate_mask.mask import try_generate_M_from_M
from HMF.drug_sensitivity.load_dataset import load_data_without_empty

import numpy, matplotlib.pyplot as plt, random

''' Settings '''
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9]
repeats = 10
iterations, burn_in, thinning = 200, 180, 2

init_S = 'random'
init_FG = 'kmeans'
K, L = 3,3

alpha, beta = 1., 1.
lambdaF = 1.
lambdaS = 1.
lambdaG = 1.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaF':lambdaF, 'lambdaS':lambdaS, 'lambdaG':lambdaG }

metrics = ['MSE', 'R^2', 'Rp']

''' Load data '''
location = project_location+"DI_MMTF/data/datasets_drug_sensitivity/overlap/"
location_data = location+"data_row_01/"
R, M_original, _, _ = load_data_without_empty(location_data+"ctrp_ec50_row_01.txt")

''' Seed all of the methods the same '''
numpy.random.seed(0)
random.seed(0)

''' Generate matrices M - one list of (M_train,M_test)'s for each fraction '''
M_attempts = 1000
all_Ms_train_test = [ 
    [try_generate_M_from_M(M=M_original,fraction=fraction,attempts=M_attempts) for r in range(0,repeats)]
    for fraction in fractions_unknown
]

''' Make sure each M has no empty rows or columns '''
def check_empty_rows_columns(M,fraction):
    sums_columns = M.sum(axis=0)
    sums_rows = M.sum(axis=1)
    for i,c in enumerate(sums_rows):
        assert c != 0, "Fully unobserved row in M, row %s. Fraction %s." % (i,fraction)
    for j,c in enumerate(sums_columns):
        assert c != 0, "Fully unobserved column in M, column %s. Fraction %s." % (j,fraction)
        
for Ms_train_test,fraction in zip(all_Ms_train_test,fractions_unknown):
    for (M_train,M_test) in Ms_train_test:
        check_empty_rows_columns(M_train,fraction)

''' Run the method on each of the M's for each fraction '''
all_performances = {metric:[] for metric in metrics} 
average_performances = {metric:[] for metric in metrics} # averaged over repeats
for (fraction,Ms_train_test) in zip(fractions_unknown,all_Ms_train_test):
    print "Trying fraction %s." % fraction
    
    # Run the algorithm <repeats> times and store all the performances
    for metric in metrics:
        all_performances[metric].append([])
    for repeat,(M_train,M_test) in zip(range(0,repeats),Ms_train_test):
        print "Repeat %s of fraction %s." % (repeat+1, fraction)
    
        BNMTF = bnmtf_gibbs(R,M_train,K,L,priors)
        BNMTF.initialise(init_FG=init_FG,init_S=init_S)
        BNMTF.run(iterations)
    
        # Measure the performances
        performances = BNMTF.predict(M_test,burn_in,thinning)
        for metric in metrics:
            # Add this metric's performance to the list of <repeat> performances for this fraction
            all_performances[metric][-1].append(performances[metric])
            
    # Compute the average across attempts
    for metric in metrics:
        average_performances[metric].append(sum(all_performances[metric][-1])/repeats)
    
 
print "repeats=%s \nfractions_unknown = %s \nall_performances = %s \naverage_performances = %s" % \
    (repeats,fractions_unknown,all_performances,average_performances)

'''
200 iterations
repeats=10 
fractions_unknown = [0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9] 
all_performances = {'R^2': [[0.4132616525416556, 0.3216617924459404, 0.4933000309890492, 0.45101045317931576, 0.44607795207607026, 0.44983599341873715, 0.4370501212356672, 0.33822371840499355, 0.4011141183566842, 0.46956462385517395], [0.3791466677237436, 0.39093112614218817, 0.3973621919002466, 0.4328470542750549, 0.4282952586666984, 0.44919765308100223, 0.44307559404567487, 0.42369544583766117, 0.4374277159155505, 0.4664704883077748], [0.43979074135439267, 0.4061555276954669, 0.3691695039533892, 0.41581019595470337, 0.4421362622691529, 0.4263277210615384, 0.3855833166841016, 0.39998349881046924, 0.3915433017670217, 0.44735649998654115], [0.4004723576209265, 0.3662106195593351, 0.44422273243047183, 0.38620079172244526, 0.39138062886854863, 0.3962060985556527, 0.4102308649417432, 0.44035769253310064, 0.41112185317946326, 0.37642894475047906], [0.42416587692308816, 0.4008225813931805, 0.3954926927432133, 0.378052044827324, 0.40269991871379685, 0.4282144966085867, 0.40271459835758416, 0.418768395127293, 0.3985681556132066, 0.40572570750558534], [0.40850659653778987, 0.3830004864504323, 0.41612209459001404, 0.3839598104995495, 0.409167709178585, 0.4001765777196048, 0.41270852121278534, 0.41509184446787184, 0.4176835861974648, 0.4078717611494238], [0.38380385119984317, 0.4155310628260017, 0.3890746604215358, 0.41067043967706496, 0.41561909959815113, 0.38112672474668174, 0.4019493969746514, 0.39859216751235005, 0.4019557364560251, 0.4014067402215493], [0.378871734926, 0.3795108667412723, 0.4171727349724911, 0.3873919731630019, 0.4075990596797836, 0.3952306680951354, 0.396568808067701, 0.38521911582243484, 0.3651873820594246, 0.3939730231717953], [0.3746858186484938, 0.3639015476271028, 0.40120550343651384, 0.3707606262629374, 0.38514779197311066, 0.38166623662949273, 0.4002437690097622, 0.36650341372182527, 0.3763040654081199, 0.37710303990942184], [0.36744587995075007, 0.35466018215088047, 0.3584185620628435, 0.3634129391137002, 0.366164342765678, 0.3702843435913663, 0.3648972298368933, 0.3620136409000724, 0.36645581167876473, 0.35028496411183874], [0.3390861685135994, 0.3571367822060898, 0.3439655689222877, 0.37514828815427037, 0.3577207995463437, 0.3416424778812861, 0.3409276845930572, 0.371453992812004, 0.33843745201125364, 0.3676847441222748], [0.3617616030435429, 0.35189094956256617, 0.3388516267660745, 0.34547134973194216, 0.3245763151753883, 0.35246847255794855, 0.36780260824969857, 0.3824871844458817, 0.30761516541233236, 0.32455930101569397], [0.29934167670489065, 0.3223871116810929, 0.33493376217352844, 0.3125144466795968, 0.30543722787241856, 0.3104879800926533, 0.32664035445394657, 0.31753613644669654, 0.31458966109640163, 0.30492399577974594], [0.30983678057250763, 0.29060189483530185, 0.31349809753138225, 0.30544218050574223, 0.26933494498749844, 0.29605698445584716, 0.2907334287091077, 0.27240990233983065, 0.30823001393673555, 0.26728880493910323], [0.25227331070046743, 0.2852793445327588, 0.27721976121133407, 0.20644548770436266, 0.2745194800521803, 0.2257732718732004, 0.25116929498764173, 0.2848511033672638, 0.22332082837684109, 0.19991750320818413], [0.1896083947071433, 0.1402458419660293, 0.20004087920449876, 0.19596398688550998, 0.17088517975386353, 0.2674178988442717, 0.20837775350845256, 0.17384828628899207, 0.19853651866594446, 0.24459664814167326]], 'MSE': [[0.097327467589591224, 0.097145284901661258, 0.079375147907430749, 0.090199133066115447, 0.095436799099386904, 0.090750815331727547, 0.088781991448673436, 0.11251442420145846, 0.096089774300989486, 0.082192587686272661], [0.096343689268789431, 0.096984810909262073, 0.095891662475473621, 0.093046331427389911, 0.092547248198513135, 0.088430973895677986, 0.084561009825728381, 0.093524244298124504, 0.092922043178507746, 0.085917934923151251], [0.090605559482045961, 0.096103896017280782, 0.10015183176667475, 0.091670431805426694, 0.087825107920041945, 0.090346088519864406, 0.099635629706699147, 0.093053259987948958, 0.096189867708630541, 0.089158467042283418], [0.096401639812239953, 0.10108454800207112, 0.087774709516491176, 0.096814854871753772, 0.096263379487223175, 0.095975923254470047, 0.095354626761176911, 0.088960545184587403, 0.091411454034669257, 0.099762035095916593], [0.091109165400093992, 0.095332388083804231, 0.096591936453685773, 0.09782667880496583, 0.094713483571603335, 0.090958336338034906, 0.096690002986772189, 0.0918208507345879, 0.093935174675147406, 0.093777786023144238], [0.093522617516059711, 0.096999693140413623, 0.093510449821793504, 0.097040418649666699, 0.094004179260966894, 0.096854556445124695, 0.093335390403068638, 0.093530283727573535, 0.09507233650299797, 0.094746416434261349], [0.099097557606289799, 0.093366141918195422, 0.097334513690536945, 0.094118461165258002, 0.094030371604020391, 0.097633523797412067, 0.093781083361182738, 0.096994822042228299, 0.095153272300514277, 0.095824953499104831], [0.099225700798841493, 0.09922451631593554, 0.093561474729543431, 0.096701436410453812, 0.094330061786492697, 0.095920432462878277, 0.095950727679990383, 0.097456479297579626, 0.10032282272477841, 0.096557428089564995], [0.099565329905278721, 0.10115540022920938, 0.096116014633824631, 0.10081331123285303, 0.096674467069155515, 0.098523009185588414, 0.095145049403074389, 0.10235645921686649, 0.097976577786177396, 0.099071074189670885], [0.10103856668463888, 0.10217615603315594, 0.10041756393713705, 0.1015292621380038, 0.10028906169567091, 0.10125441244986784, 0.1003010685100585, 0.1007708609377841, 0.10107103750898504, 0.10349293171938985], [0.10500698246224346, 0.10098896665098507, 0.10586230686623656, 0.09917331319708618, 0.10139045547819495, 0.10383119777402294, 0.1053444621818002, 0.099392672125951487, 0.10596965320594756, 0.10033016616858208], [0.10214901140578347, 0.10219838520251766, 0.10599974997969606, 0.1039918036679333, 0.10692991751936767, 0.102460150793572, 0.10067086624877801, 0.098234091001109941, 0.10971666360732829, 0.10784203999204274], [0.11159185321205708, 0.10713815832802474, 0.10586086522027455, 0.1090373716620217, 0.11125441888195241, 0.11028664918393181, 0.10664869509855626, 0.10842380352543213, 0.10931850822923271, 0.11126772016713384], [0.11014953921049504, 0.11331191653906318, 0.1087415993849242, 0.11008332304853237, 0.11602987168031474, 0.11188878400336712, 0.11291496190018112, 0.1153717217670631, 0.11000758426186381, 0.11669523343515072], [0.11865081855180405, 0.11434651721488792, 0.11445951379883142, 0.12625340098524976, 0.11592190675352111, 0.1225560271345333, 0.11845204081494319, 0.11412105456780397, 0.12345966943302621, 0.12713920033208786], [0.12887139730293604, 0.13716967200212207, 0.12698542451107131, 0.12794758527395667, 0.13160024582721622, 0.11640153641942153, 0.12620158922017427, 0.13152009908351558, 0.12741208396007059, 0.11984872397270487]], 'Rp': [[0.64608640909334047, 0.57645475054651063, 0.70428584619486567, 0.67170460522298625, 0.67406814078948851, 0.6721299519031011, 0.66222490554225977, 0.59352143663064438, 0.63412402393588752, 0.68701946248330903], [0.6180930449508375, 0.62653769385334712, 0.63112213059404476, 0.65801320732077828, 0.65523848712997179, 0.67050372431533367, 0.66904374385219989, 0.65106879683386598, 0.66203679341354227, 0.68363577153056154], [0.66352471567057725, 0.6384209624807996, 0.61267188237543124, 0.64515866994761639, 0.665042317460806, 0.65351491052640687, 0.62556655042045961, 0.63421116057589932, 0.62883849937536718, 0.66904396382067222], [0.6343194441436194, 0.60838158807668252, 0.66662946742369689, 0.62383170886824735, 0.62731131220781267, 0.63132796732603336, 0.64149544292562832, 0.66366545622722994, 0.64258061281553447, 0.61749566796179856], [0.65252648775746036, 0.63418326252084278, 0.62996084390864382, 0.61893290560972092, 0.63656647474338846, 0.65454356499619126, 0.63605807498786826, 0.64751617356590485, 0.63323354488125727, 0.63761152589525727], [0.64002554423724811, 0.62099271270732692, 0.64552324231249569, 0.62389248557382104, 0.64165624959795453, 0.63412252504516275, 0.6442597110920889, 0.64498255867372623, 0.64672098074049078, 0.63961326219142867], [0.62213372535652289, 0.64549079834212564, 0.62658536373642759, 0.64175418083950353, 0.64565129156466106, 0.62126762919143619, 0.63559839097043802, 0.63283746116270245, 0.63553119366135213, 0.63505545648660078], [0.61882612356968192, 0.62126439089669827, 0.64595998590327308, 0.62520679888898245, 0.63908439740948852, 0.63009957418223062, 0.63061837652320563, 0.62373299480734556, 0.60805235076821107, 0.62937238139223417], [0.61554623611977732, 0.60634952944560905, 0.63504293179061277, 0.61298209433446893, 0.62255481415893799, 0.6196143477638838, 0.63374332420887081, 0.60981582689054015, 0.61785997984621543, 0.61786451995844283], [0.61187740885523478, 0.60497072446495959, 0.60485988493740495, 0.60732629970514485, 0.60929949557155128, 0.61348640083184292, 0.60914449096783962, 0.60730838404152843, 0.6087585509093083, 0.59753216006382892], [0.59185345169443082, 0.60707111873423503, 0.59388767041924073, 0.61547573912919551, 0.60205325816582145, 0.59412787960050562, 0.59342915091909065, 0.6140829054027932, 0.59098859174072138, 0.61129658342547288], [0.60596489970995637, 0.59973966918402033, 0.59158390508406389, 0.59582979708283534, 0.57990025084729335, 0.59813870718843454, 0.61065668562521824, 0.62028853437618903, 0.57189109356541534, 0.57784104242918222], [0.56353624267517854, 0.58289294868417696, 0.58862744553586788, 0.5723605058186686, 0.56545173570969132, 0.57295212614019964, 0.58345431063639575, 0.57961186552141075, 0.57496775681207579, 0.56633939677360801], [0.57370339562503325, 0.557676534883361, 0.57707914501096569, 0.56978396872855674, 0.55032332450744581, 0.56293425355617754, 0.56243283846962533, 0.55276116482113069, 0.57080015360484593, 0.54000790071994631], [0.5424154174111715, 0.5517444379029055, 0.54883367958592211, 0.52039083477004755, 0.54643869479917184, 0.52734087825506637, 0.53331681504854844, 0.55709807393985766, 0.52552219737836781, 0.51884063466209018], [0.50544418515911538, 0.48607948884633723, 0.51241763955151576, 0.50675612131521064, 0.50749678184212632, 0.5430767594299275, 0.50753807149238661, 0.4961805346824219, 0.51339614517775134, 0.53284934158416131]]} 
average_performances = {'R^2': [0.4221100456503287, 0.4248449195895595, 0.4123856569536777, 0.4022832584162166, 0.40552244678128585, 0.40542889880035216, 0.3999729879633855, 0.390672536669904, 0.3797521812626781, 0.3624037896162788, 0.35332039587624664, 0.34574845759610695, 0.31487923529809714, 0.2923433032813057, 0.24807693860142344, 0.1989521387966379], 'MSE': [0.092981342553330723, 0.092016994840061803, 0.093474013995689664, 0.094980371602059938, 0.094275580307183984, 0.094861634190192667, 0.095733470098474285, 0.096925108029605869, 0.09873966928516989, 0.1012340921614692, 0.10272901761110505, 0.1040192679418129, 0.10908280435086173, 0.11251945352309553, 0.11953601495866888, 0.12739583575731889], 'Rp': [0.65216195323423942, 0.65252933937944824, 0.64359936326540357, 0.63570386679762847, 0.63811328588665361, 0.6381789272171744, 0.63419054913117701, 0.62722173743413512, 0.61913736045173584, 0.60745638003486435, 0.60142663492315074, 0.5951834585092608, 0.57501943343072726, 0.56175026799270866, 0.53719416637531481, 0.51112350690809538]}
'''